# iptables 的使用
## 概述
&emsp;&emsp;iptables 是 linux 的防火墙工具，它能帮助我们基于规则进行网络流量控制。在 CentOS、Ubuntu 这些发行版本中，一般情况下我们会用更高层的封装，如 FirewallD、ufw。由于 Docker 会和 FirewallD 冲突，因此在部署环境的时候，一般选择将 FirewallD 卸载之后直接使用 iptables。这里记录一下 iptables 的一些学习思路。

## 概念
### 规则（rule）
&emsp;&emsp;`来自 10.10.50.0 的访问，就将其拒绝`，这就是一条规则。规则是 iptables 里面的最小单元。

### 链（chain）
&emsp;&emsp;在实际情况里，我们的安全策略往往不只一条规则，这些规则可能有执行的优先次序等要求。因此就涉及到了链这个概念。简单来讲，链就是将多个规则串起来的集合单位，在执行链时，规则从上到下依次进行匹配。

### 表（table）
&emsp;&emsp;在更复杂的场景下，需要将链再整合在一起，因此就引申出了表的概念。

### 总结
&emsp;&emsp;在 iptables 中，有四张表：

- filter: 这里面的链、规则，主要决定一个数据包是否可以到达目标进程的端口；
- mangle: 这里面的链、规则，主要决定数据包的内容；
- nat: 这里面的链、规则，主要可以修改源和目标的 ip 地址，从而进行包路由；
- raw: 这里面的链、规则，主要能基于数据包的状态进行规则的设定。

&emsp;&emsp;上述四张表中，内置了一些链，且每个链都有默认包处理策略，默认策略一般在链中的所有规则都没有匹配时生效。

- filter
  1. INPUT: 对路由策略分派过来的包到达目标进行端口之前进行匹配并处理
  2. FORWARD: 对路由策略分派过来的包进行路由转发
  3. OUTPUT: 从本地的目标进行端口处理好的包如何返回/要不要返回给请求方
- mangle
  1. PREROUTING: 包在到达网口时，对其进规则匹配
  2. INPUT: 同上
  3. FORWARD: 同上
  4. OUTPUT: 同上
  5. POSTROUTING: 包在离开网口时，对其进行规则匹配
- nat
  1. PREROUTING: 同上
  2. OUTPUT: 同上
  3. POSTROUTING: 同上
- raw
  1. PREOUTING: 同上
  2. OUTPUT: 同上

> 需要注意，上述四张表中，虽然链的名称是相同的，但是它们并不是同一个链。一个链只能引用同一个表里的链，不能跨表引用。

&emsp;&emsp;平时我们说的防火墙策略的配置，就是在上述各个表的各个链中配置具体的规则。

## 使用
### 
